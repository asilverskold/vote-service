<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet author="vasily" id="changeset1">
        <sql>
            CREATE TABLE USER
            (
                id       number generated always as identity ( start with 1 increment by 1 ) primary key,
                username varchar(512),
                password varchar(512),
                active   bit

            );
        </sql>
        <sql>
            CREATE TABLE USER_ROLE
            (
                user_id number,
                role    varchar(512),
                constraint fk_user_roles_user_id foreign key (user_id) references USER (id) on delete cascade
            );
        </sql>

    </changeSet>

    <changeSet author="vasily" id="changeset2">
        <sql>
            CREATE TABLE POLL
            (
                id    number generated always as identity ( start with 1 increment by 1 ) primary key,
                date  timestamp not null,
                title varchar(512)
            );
        </sql>

        <sql>
            CREATE TABLE POLL_OPTION
            (
                id            number generated always as identity ( start with 1 increment by 1 ) primary key,
                restaurant_id number NOT NULL,
                poll_id       number NOT NULL,
                voted_count   number default 0,
                constraint fk_poll_option_poll_id foreign key (poll_id) references POLL (id)
            );
        </sql>
        <sql>
            CREATE TABLE VOTE
            (
                id             number generated always as identity ( start with 1 increment by 1 ) primary key,
                poll_id        number,
                user_id        number,
                poll_option_id number,
                constraint fk_vote_poll_id foreign key (poll_id) references POLL (id),
                constraint fk_vote_poll_option_id foreign key (poll_option_id) references POLL_OPTION (id),
                constraint fk_vote_user_id foreign key (user_id) references USER (id)
            );
        </sql>
    </changeSet>

    <changeSet author="vasily" id="changeset3">
        <sql>
            INSERT INTO USER(id, username, password, active)
            VALUES (1, 'admin', 'admin', 1)

        </sql>
        <sql>
            INSERT INTO USER_ROLE(user_id, role)
            VALUES (1, 'ADMIN')

        </sql>

    </changeSet>

    <changeSet author="vasily" id="changeset4">
        <sql>
            CREATE TABLE RESTAURANT
            (
                id   NUMBER GENERATED ALWAYS AS IDENTITY ( START WITH 1 INCREMENT BY 1 ) PRIMARY KEY NOT NULL,
                name VARCHAR(255)                                                                    NOT NULL,
                menu_id NUMBER,
                CONSTRAINT pk_restaurant PRIMARY KEY (id)
            );

        </sql>
        <sql>
            CREATE TABLE MENU
            (
                id            NUMBER GENERATED ALWAYS AS IDENTITY ( START WITH 1 INCREMENT BY 1 ) PRIMARY KEY NOT NULL,
                restaurant_id NUMBER                                                                          NOT NULL,
                CONSTRAINT FK_MENU_ON_RESTAURANT FOREIGN KEY (restaurant_id) REFERENCES RESTAURANT (id)
            );

            ALTER TABLE RESTAURANT
                ADD CONSTRAINT FK_RESTAURANT_ON_MENU FOREIGN KEY (menu_id) REFERENCES MENU (id);
            ALTER TABLE POLL_OPTION
                ADD CONSTRAINT FK_POLL_OPTION_ON_RESTAURANT FOREIGN KEY (restaurant_id) REFERENCES RESTAURANT (id);
        </sql>
        <sql>
            CREATE TABLE DISH
            (
                id      NUMBER GENERATED ALWAYS AS IDENTITY ( START WITH 1 INCREMENT BY 1 ) PRIMARY KEY NOT NULL,
                name    VARCHAR(255)                                                                    NOT NULL,
                price   NUMBER,
                menu_id NUMBER                                                                          NOT NULL
            );


            ALTER TABLE DISH
                ADD CONSTRAINT FK_DISH_ON_MENU FOREIGN KEY (menu_id) REFERENCES MENU (id);


        </sql>
    </changeSet>

</databaseChangeLog>